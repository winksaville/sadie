machine:
  environment:
    REQUESTED_PYTHON_VER: 3.5.1
    INSTALL_PREFIX_DIR_HOME_REL: ~/opt
    INSTALL_PREFIX_DIR: ${HOME}/opt
    PATH: ${INSTALL_PREFIX_DIR}/bin:${INSTALL_PREFIX_DIR}/x-tools/x86_64-unknown-elf/bin:${INSTALL_PREFIX_DIR}/x-tools/i386-unknown-elf/bin:${INSTALL_PREFIX_DIR}/x-tools/arm-unknown-eabi/bin:${INSTALL_PREFIX_DIR}/Python-${REQUESTED_PYTHON_VER}/bin:${PATH}

  #python:
  #  version: 3.5.1

checkout:
  post:
    # Update the submodules
    - git submodule sync --recursive
    - git submodule update --recursive --init

dependencies:
  cache_directories:
    #- ${INSTALL_PREFIX_DIR_HOME_REL}
    # The above environment doesn't work so specify ~/opt directly
    - ~/opt

  pre:
    # Install base dependencies
    - ./ubuntu_base_dependencies_install.sh

    # Install latest compilers
    - GCC_VERSION=6 ./ubuntu_gcc_g++_install.sh

    # Install python 3.5.1, needed because subprocess.run is used in vendor-install-tools
    # REQUESTED_PYTHON_VER set above
    - vendor-install-tools/python_install.sh

    # Test that python is OK
    - which python
    - python --version
    - which python2
    - python2 --version
    - which python3
    - python3 --version
    - python3 -c 'print("OK")'

    # Install the other tools we need
    - vendor-install-tools/install.py meson --installPrefixDir=${INSTALL_PREFIX_DIR}
    - vendor-install-tools/install.py ninja --installPrefixDir=${INSTALL_PREFIX_DIR}
    - vendor-install-tools/install.py ct-ng --installPrefixDir=${INSTALL_PREFIX_DIR}
    - vendor-install-tools/install.py gcc-x86_64 --installPrefixDir=${INSTALL_PREFIX_DIR}
    - vendor-install-tools/install.py gcc-i386 --installPrefixDir=${INSTALL_PREFIX_DIR}
    - vendor-install-tools/install.py gcc-arm --installPrefixDir=${INSTALL_PREFIX_DIR}
    - vendor-install-tools/install.py qemu-system-arm --installPrefixDir=${INSTALL_PREFIX_DIR}

test:
  override:
    - circleci-matrix/process-matrix platform-matrix.yml:
        parallel: true
